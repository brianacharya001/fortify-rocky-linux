# Setting up Fortify Image with Base of Rocky Linux 
FROM docker.io/rockylinux/rockylinux:8

# Copy Over the Require Artifacts to Install Fortify
COPY artifacts /artifacts

# Install Required Dependencies
RUN yum install unzip -y
RUN wget --user=admin  --password=#Newyear2065# "http://nexus3-openshift-operators.apps.vapo-ppd.va.gov/#browse/browse:vic:vic%2Fjdk-11.0.12_linux-x64_bin.rpm"
# Install Oracle JDK 11
WORKDIR /artifacts
RUN rpm -ivh jdk-11.0.12_linux-x64_bin.rpm

# Setting the Environment Variables for Java
ENV SetJavaHome=/usr/java/jdk-11.0.12/
ENV JAVA_HOME=/usr/java/jdk-11.0.12/
ENV PATH=$JAVA_HOME/bin:$PATH

# Installing Tomcat as Fortify SSC is a Java Based Application
RUN wget https://mirrors.ocf.berkeley.edu/apache/tomcat/tomcat-9/v9.0.48/bin/apache-tomcat-9.0.48.tar.gz
RUN mkdir /opt/tomcat
RUN tar -xvf apache-tomcat-9.0.48.tar.gz -C /opt/tomcat --strip-components=1

# Set Catalina Environment Variables
ENV CATALINA_HOME /opt/tomcat
ENV PATH $CATALINA_HOME/bin:$PATH

# Deploy the SCC WAR to the Tomcat Deployments Folder
RUN wget --user=admin  --password=#Newyear2065# http://nexus3-openshift-operators.apps.vapo-ppd.va.gov/repository/vapo/vapo/vapo/ssc.war
RUN mv ssc.war /opt/tomcat/webapps

# Setting up for SSL/443
# Copy over the Configuration Files used by Tomcat. 
# Note: These can be changed for ConfigMaps in Kubernetes
COPY config /config
WORKDIR /config

# Location for the Java Keystores
RUN mkdir /opt/certs

# Generate a JKS for Self Signing Certificate/Server Certificate
RUN keytool -genkey  -keyalg RSA  -dname "CN=jsvede.bea.com,OU=DRE,O=BEA,L=Denver,S=Colorado,C=US" -keypass v8PO!R0ckS  -storepass v8PO!R0ckS -keystore /opt/certs/fortify.keystore

RUN mv server.xml /opt/tomcat/conf/server.xml
RUN mv web.xml /opt/tomcat/webapps/manager/WEB-INF/web.xml
RUN mv tomcat-users.xml /opt/tomcat/conf/tomcat-users.xml
RUN mv context.xml /opt/tomcat/webapps/manager/META-INF/context.xml

# Utilize a Port other than default
# This can be changed in the server.xml
EXPOSE 2424

# Setup the Runtime for the Container
CMD ["catalina.sh", "run"]
